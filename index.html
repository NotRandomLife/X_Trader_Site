<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>X Trader Web Real</title>
</head>
<body style="background:#000;color:white;font-family:Arial;padding:20px">
  <h1>📈 X Trader Web - Real Trading</h1>
  <p>✅ Trading bot synced every 5 mins (real Binance trades with SL/TP and repay)</p>
  <script>
    const apiUrl = "http://127.0.0.1:5000/api/latest";
    const symbol = "BTCUSDC";
    let isRunning = true;

    const sleep = ms => new Promise(r => setTimeout(r, ms));

    async function syncLoop() {
      while (isRunning) {
        const now = new Date();
        const mins = now.getMinutes();
        const secs = now.getSeconds();
        const ms = now.getMilliseconds();
        const nextMinute = 5 * Math.ceil(mins / 5);
        const delay =
          ((nextMinute === mins && secs === 0) ? 0 : ((nextMinute - mins + (nextMinute === 60 ? -60 : 0)) * 60 - secs)) * 1000 - ms;
        console.log("⏳ Waiting", delay / 1000, "seconds to sync...");

        await sleep(delay > 0 ? delay : 0);

        await executeCycle(); // esegue 1 ciclo di trading
      }
    }

    async function executeCycle() {
      console.log("🟢 Executing trading cycle at", new Date().toLocaleTimeString());

      try {
        const controller = new AbortController();
        const timeout = setTimeout(() => controller.abort(), 60000); // 60s timeout

        const res = await fetch(apiUrl, { signal: controller.signal });
        clearTimeout(timeout);

        if (!res.ok) throw new Error("Signal fetch error");

        const { signal } = await res.json();
        console.log("📩 Received signal:", signal);

        // Qui andrà tutta la logica reale: check posizione, chiusura, repay, apertura, SL/TP ecc.
        console.log("⚙️ Eseguo operazioni su Binance...");

      } catch (e) {
        console.warn("❌ No signal received within 60s or fetch error.");
      }
    }

    syncLoop();
  </script>
</body>
</html>